# 設計ドキュメント

この文書は、`docs/definitions.md` で定義した要件をもとにした設計ドラフトです。

---

## 1. システム概要

- Nostr の CUI/TUI クライアント。
- 初期実装は CUI（CLI）クライアントとし、後から TUI に拡張しやすい構成とする。
- 主な機能
  - テキスト投稿（kind 1）。
  - テキスト投稿イベントの受信と一覧表示。
  - 複数リレーへの接続と購読。
  - プロフィール（kind 0）閲覧。
  - 対応イベント kind は当面 `0（プロフィール）` と `1（テキストノート）` に限定し、将来的に返信（kind 1 による reply）を追加実装できる設計とする。

---

## 2. アーキテクチャ方針

- 単一バイナリ構成
  - Go でビルドした単一バイナリとして配布・実行できることを前提とする。
  - 外部依存（設定ファイルやキャッシュ）は任意で使用可能だが、存在しなくても動作する。
- レイヤ分離
  - **UI 層**: CLI/TUI の入出力・キー操作・コマンド解釈。
  - **アプリケーションサービス層**: 投稿・タイムライン取得・プロフィール取得といった「ユースケース単位の処理」。
  - **Nostr インフラ層**: リレー接続管理、購読・イベント送受信、イベント検証。
  - **設定・永続化層**: 設定・鍵情報・ローカルキャッシュなどの読み書き。
- UI 層からはアプリケーションサービス層のインターフェースを呼び出すことで、CUI/TUI を差し替え可能にする。

---

## 3. パッケージ構成案

Go のパッケージ構成イメージは次の通りとする。

- `cmd/noscli`
  - `main` パッケージ。CLI エントリポイント。
  - CLI フレームワークとして `spf13/cobra` を使用し、コマンド・フラグを定義して `internal/app` のサービスを呼び出す。
- `internal/app`
  - ユースケース単位のサービス群。
  - 例: `TimelineService`, `PostService`, `ProfileService`, `RelayService` など。
  - UI 層から呼び出される公開インターフェースを提供する。
- `internal/nostr`
  - Nostr プロトコルとのやりとりを集約する層。
  - リレー接続（WebSocket）、購読管理、イベント送受信、署名検証など。
  - `github.com/gorilla/websocket` を用いた自前実装を基本とし、`github.com/nbd-wtf/go-nostr` など既存ライブラリは実装・仕様の参考にとどめる。
- `internal/config`
  - 設定ファイル・環境変数の読み取りと構造体へのマッピング。
  - リレー一覧、デフォルトフィルタ、鍵ファイルパスなど。
- `internal/storage`
  - nsec / 秘密鍵などを扱う モジュール。
  - 入力方法（対話入力・環境変数・ファイル）や保存ポリシーを統一して扱う。
- `internal/logging`（任意）
  - ログ出力のラッパー。ログレベル制御やフォーマット指定。

---

## 4. Nostr 連携設計

### 4.1 リレー接続管理

- `RelayManager` 的なコンポーネントを `internal/nostr` に持つ。
  - 複数リレーへの同時接続を管理（WebSocket 接続の確立・再接続）。
  - 各リレーごとの購読状態（サブスクリプション ID・フィルタ）を管理。
- 接続リレー
  - デフォルトリレーは設定ファイルで定義。
  - CLI オプションで追加・一時的な上書きが可能。
  - 複数リレーからのイベントは基本的に集約して表示し、将来的に特定リレーのみを対象とするフィルタを追加できる余地を残す。

### 4.2 購読・イベント処理

- 購読（REQ）の単位
  - タイムライン購読：`kinds: [1]` を基本とする。
  - プロフィール取得：`kinds: [0]` で特定 pubkey をフィルタ。
- イベントループ
  - 各リレーごとに受信ループを持ち、受信イベントをチャネル経由でアプリケーション層に通知。
  - 購読 ID ごとにハンドラを登録し、タイムライン／プロフィールなど用途別に処理を分ける。
- イベント検証
  - 署名検証と必須フィールドチェックを行い、無効イベントは無視または警告ログに出力。
  - タイムライン表示はリアルタイムストリーム表示を主とし、オプションで直近 N 件を取得するバッチ的な利用も将来的に検討する。

---

## 5. CLI インターフェース設計（CUI）

初期実装としての CUI コマンド構成案。

- エントリポイント
  - 実行ファイル名: `noscli`
- 主コマンド案
  - `noscli timeline`  
    - 単一リレーに接続し、テキストノートのストリーム表示（Ctrl+C などで明示停止するまで受信し続ける）。
    - オプション例（案）:
      - `--relay` 受信リレー URL（未指定時は設定値を利用）
  - `noscli post`  
    - テキスト投稿の送信。
    - オプション例（案）:
      - `-m` テキスト本体（未指定時は標準入力から読む）
      - `--reply-to` 返信先イベント ID（対応する場合）
  - `noscli profile`  
    - プロフィール取得・表示。
    - オプション例（案）:
      - `--pubkey` 対象ユーザー pubkey
      - 指定なしの場合は自分のプロフィール取得（自分の pubkey が設定されている場合）
  - `noscli relay`  
    - リレー一覧参照・追加・削除などの管理コマンド（将来拡張含む）。

### 5.1 `noscli timeline` 詳細

- 目的
  - kind 1（テキストノート）イベントを購読し、検証済みの投稿のみをストリーム表示する。初期実装は単一リレー接続だが、`TimelineService`/`nostr.Client` は将来の複数リレー対応を見据えてインターフェースを定義する。
- 基本フロー
  1. CLI が `TimelineService` に対し、利用するリレーを指定する（初期は単数、将来的に複数を渡せる構造体にする）。
  2. `TimelineService` は `nostr.Client` を通じてリレーへ REQ を送信し、コンテキストがキャンセルされるまでイベントを購読し続ける。複数リレーの場合は内部でストリームを多重化する予定。
  3. 受信イベントは署名検証（`docs/design.md:80` 参照）を通過したもののみを整形し、CLI へストリーム表示する。
- CLI オプション
  - `--relay`: 接続リレー URL。未指定時は設定ファイルまたは既定リストを使用（単一リレー）。
- 表示仕様
  - タイムスタンプはローカルタイムゾーンで `2006-01-02 15:04:05` 形式。
  - Event ID 末尾 8 文字とリレー URL を末尾コメントとして表示し、複数リレーからの同一イベントは ID で重複排除。
  - 常時ストリームのため、表示済み ID は LRU 的に記録して重複出力を抑制する。
- エラーハンドリング
  - リレー接続失敗は標準エラーに WARN として記録し、他リレーの処理を継続。
  - 全リレー失敗時は非 0 終了コードを返す。
  - 署名検証失敗や無効メッセージはサイレントに捨てず、`--verbose` 時のみ詳細を出力。
- 拡張余地
  - 後続の TUI では同じ `TimelineService` を呼び出し、UI だけを差し替える。

---

## 6. 鍵管理・設定

### 6.1 鍵管理

- 対応する鍵形式
  - 最低限、秘密鍵（nsec 形式または hex 形式）と公開鍵（npub または hex）に対応。
- 入力方法案
  - 環境変数（例: `NOSTR_NSEC`）。
  - 設定ファイル内の暗号化済みフィールド（要検討）。
  - 対話的入力（パスワード入力と同様にエコーバックなし）。
- 保存ポリシー
  - 初期実装ではローカルファイル（設定ファイル）への保存を許容し、適切なファイルパーミッション（例: `0600`）で保護する。
  - 将来的に OS 依存のセキュアストアを使う場合に備え、鍵ストレージはインターフェースで抽象化する。

### 6.2 設定ファイル

- 格納場所案
  - Linux 向けを対象とし、`$HOME/.config/noscli/config.toml` を既定パスとする。
- 主な設定項目
  - リレー一覧（URL と有効・無効フラグ）。
  - デフォルト購読フィルタ（`limit`, `since`, `until` など）。
  - デフォルトの公開鍵／秘密鍵の参照方法（環境変数名や鍵 ID）。
  - 設定ファイルフォーマットは TOML とする。
  - 対象プラットフォームは Linux を想定する。

---

## 7. ロギング・エラー処理

- ログ出力
  - デフォルトは標準エラー出力に INFO レベル以上を出力。
  - `--verbose` フラグで DEBUG を含めた詳細ログを有効化。
  - ログ形式は人間が読みやすいテキストログとし、JSON ログは当面想定しない。
- エラー表示
  - ユーザー操作の失敗（接続不可、認証エラーなど）は、CLI 上で意味がわかるメッセージを表示。
  - 内部エラー詳細はログに出し、必要に応じて `--debug` でスタックトレース等も出力可能にする。

---

## 8. TUI 拡張方針

- TUI ライブラリ案
  - 例として `bubbletea` や `tview` などの採用を検討。
  - UI ライブラリの選定は後からでも変更しやすいよう、UI 層をアプリケーションサービス層から疎結合にする。
- 画面構成イメージ
  - タイムライン一覧ペイン。
  - 投稿入力ペイン。
  - ステータスバー（接続リレー数・エラー状況など）。
- CUI と TUI で共通化する部分
  - コマンド／キー操作のマッピングを可能な限り共通化し、CUI で慣れた操作体系を TUI でも維持する。
  - アプリケーションサービス層のインターフェースを明確に定義し、後から TUI 実装を別パッケージとして追加しやすい構成とする。

---

## 9. 今後の詳細設計

上記は高レベルの設計方針です。  
ユーザーからの回答をもとに、次のような詳細設計を別途進める想定です。

- コマンドごとの詳細仕様（引数・フラグ・出力フォーマットの定義）。
- パッケージ内インターフェースの具体的なメソッドシグネチャ。
- 設定ファイルスキーマ（YAML/JSON など）の確定。
- リレー接続戦略（再接続ポリシー、タイムアウト、バックオフアルゴリズム）。
- 鍵管理のセキュリティ要件と具体的な実装方針。
